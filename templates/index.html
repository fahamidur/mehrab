{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
    <div class="mb-8 p-4 rounded-lg shadow-sm bg-white dark:bg-gray-800 sticky top-4 z-10">
      <div class="relative">
        <input type="text" id="searchInput" placeholder="Search news articles..." 
               class="w-full p-3 pl-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100 dark:bg-gray-700 dark:text-white"/>
        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <section id="home">
      {% if current_user.is_authenticated %}
      <div id="recommendedSection" class="mb-12">
        <h2 class="text-2xl font-bold mb-6">Recommended For You</h2>
        <div id="recommendedGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
      {% endif %}

      <h2 class="text-2xl font-bold mb-6">General News Feed</h2>

      <div class="mb-6 flex flex-wrap gap-2">
        <button onclick="toggleCategory(this)" data-category="Technology" class="category-btn px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white">Technology</button>
        <button onclick="toggleCategory(this)" data-category="Politics" class="category-btn px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white">Politics</button>
        <button onclick="toggleCategory(this)" data-category="Business" class="category-btn px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white">Business</button>
        <button onclick="toggleCategory(this)" data-category="Entertainment" class="category-btn px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white">Entertainment</button>
      </div>

      <div id="newsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="pagination" class="flex justify-center mt-6"></div>
    </section>
{% endblock %}

{% block scripts %}
<script>
    const current_user = {{ 'true' if current_user.is_authenticated else 'false' }};

    let allArticles = [];
    let recommendedArticles = [];
    let userPreferences = {
      categories: ['Technology', 'Politics', 'Sport', 'Business', 'Science', 'Entertainment'],
      readingTime: '10-15 mins'
    };
    let savedArticles = JSON.parse(localStorage.getItem('savedArticles')) || [];

    // Pagination variables
    let currentPage = 1;
    const articlesPerPage = 10;

    function initializeCategoryButtons() {
        document.querySelectorAll('.category-btn').forEach(button => {
            const category = button.dataset.category;
            if (userPreferences.categories.includes(category)) {
                button.classList.add('bg-blue-600', 'text-white');
                button.classList.remove('bg-gray-200', 'dark:bg-gray-700');
            } else {
                button.classList.remove('bg-blue-600', 'text-white');
                button.classList.add('bg-gray-200', 'dark:bg-gray-700');
            }
        });
    }

    function toggleCategory(button) {
      const category = button.dataset.category;
      const index = userPreferences.categories.indexOf(category);
      if (index === -1) {
        userPreferences.categories.push(category);
      } else {
        userPreferences.categories.splice(index, 1);
      }
      document.getElementById('searchInput').value = '';
      initializeCategoryButtons();
      renderFilteredNews();
    }

    async function fetchArticles() {
      try {
          const response = await fetch('/api/articles');
          if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
          }
          const data = await response.json();

          if (!current_user) {
              allArticles = data.general;
              renderFilteredNews();
          } else {
              recommendedArticles = data.recommendations || [];
              allArticles = data.general || [];
              renderRecommendedNews();
              renderFilteredNews();
          }
      } catch (error) {
          console.error("Error fetching articles:", error);
          document.getElementById('newsGrid').innerHTML = `
              <div class="col-span-full p-8 text-center rounded-lg bg-white dark:bg-gray-800 shadow-md text-red-600">
                  <h3 class="mt-2 text-lg font-medium">Failed to load articles</h3>
                  <p class="mt-1 text-gray-500 dark:text-gray-400">Please try again later.</p>
                  <p class="mt-1 text-sm text-gray-400">Error: ${error.message}</p>
              </div>
          `;
      }
    }

    function renderRecommendedNews() {
      const container = document.getElementById('recommendedGrid');
      container.innerHTML = '';

      if (recommendedArticles.length === 0) {
        container.innerHTML = `
            <div class="col-span-full p-8 text-center rounded-lg bg-white dark:bg-gray-800 shadow-md">
                <h3 class="mt-2 text-lg font-medium">No recommendations yet</h3>
                <p class="mt-1 text-gray-500 dark:text-gray-400">Start reading articles to get personalized recommendations.</p>
            </div>
        `;
        return;
      }

      recommendedArticles.forEach(article => {
        renderArticle(article, container);
      });
    }

    function renderFilteredNews(page = 1) {
      currentPage = page;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      const filteredArticles = allArticles.filter(article => {
        const title = (article.title || '').toLowerCase();
        const summary = (article.summary || '').toLowerCase();
        const content = (article.content || '').toLowerCase();
        const category = article.category || '';
        const tags = article.tags || [];

        const matchesSearch = searchQuery === '' || 
                              title.includes(searchQuery) || 
                              summary.includes(searchQuery) || 
                              content.includes(searchQuery);

        const matchesCategory = !current_user || 
                                userPreferences.categories.length === 0 ||
                                userPreferences.categories.some(cat => 
                                  category === cat || 
                                  (Array.isArray(tags) && tags.includes(cat)) ||
                                  (typeof tags === 'string' && tags.split(',').includes(cat))
                                );

        return matchesSearch && matchesCategory;
      });

      const container = document.getElementById('newsGrid');
      container.innerHTML = '';

      if (filteredArticles.length === 0) {
        container.innerHTML = `
            <div class="col-span-full p-8 text-center rounded-lg bg-white dark:bg-gray-800 shadow-md">
                <h3 class="mt-2 text-lg font-medium">No articles found</h3>
                <p class="mt-1 text-gray-500 dark:text-gray-400">Try adjusting your search or filter criteria.</p>
            </div>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      // Pagination slice
      const startIndex = (page - 1) * articlesPerPage;
      const paginatedArticles = filteredArticles.slice(startIndex, startIndex + articlesPerPage);

      paginatedArticles.forEach(article => {
        renderArticle(article, container);
      });

      renderPagination(filteredArticles.length);
    }

    function renderPagination(totalArticles) {
      const paginationContainer = document.getElementById('pagination');
      paginationContainer.innerHTML = '';

      const totalPages = Math.ceil(totalArticles / articlesPerPage);
      if (totalPages <= 1) return;

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.className = `px-3 py-1 mx-1 rounded ${
          i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
        }`;
        btn.addEventListener('click', () => renderFilteredNews(i));
        paginationContainer.appendChild(btn);
      }
    }

    function renderArticle(article, container) {
      const isSaved = savedArticles.some(saved => saved.id === article.id);
      const category = article.category || article.tags?.[0] || 'General';
      const summary = article.summary || (article.content ? article.content.substring(0, 200) + '...' : 'No summary available.');
      const source = article.source || 'Unknown Source';
      const timeToRead = article.timeToRead || 'N/A';
      const title = article.title || 'Untitled Article';
      const image = article.image || `https://placehold.co/600x400?text=${encodeURIComponent(title)}`;

      const articleElement = document.createElement('article');
      articleElement.className = `overflow-hidden rounded-lg shadow-md transition-transform duration-300 transform hover:-translate-y-1 hover:shadow-lg bg-white dark:bg-gray-800`;
      articleElement.innerHTML = `
        <img src="${image}" alt="${title}" class="w-full h-48 object-cover"/>
        <div class="p-5">
          <div class="flex justify-between items-start mb-2">
            <span class="inline-block px-2 py-1 text-xs font-semibold bg-blue-100 text-blue-800 rounded-full dark:bg-blue-900 dark:text-blue-300">${category}</span>
            <button onclick='handleSaveArticle(${JSON.stringify(article)})' class="${isSaved ? 'text-blue-600' : 'text-gray-500 hover:text-blue-600'}" aria-label="Save article">
              <svg class="w-5 h-5" fill="${isSaved ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
              </svg>
            </button>
          </div>
          <h3 class="text-xl font-bold mb-2">
            <a href="/article/${article.id}" class="hover:underline">${title}</a>
          </h3>
          <p class="mb-4 text-gray-600 dark:text-gray-300">${summary}</p>
          <div class="flex justify-between items-center mt-4">
            <span class="text-sm text-gray-500">${source}</span>
            <span class="text-sm text-gray-500">${timeToRead}</span>
          </div>
        </div>
      `;
      container.appendChild(articleElement);
    }

    function handleSaveArticle(article) {
      const index = savedArticles.findIndex(item => item.id === article.id);
      if (index === -1) {
          savedArticles.push(article);
      } else {
          savedArticles.splice(index, 1);
      }
      localStorage.setItem('savedArticles', JSON.stringify(savedArticles));
      renderFilteredNews(currentPage);
      {% if current_user.is_authenticated %}
        renderRecommendedNews();
      {% endif %}
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeCategoryButtons();
      document.getElementById('searchInput').addEventListener('input', () => renderFilteredNews(1));
      fetchArticles();
    });
</script>
{% endblock %}
